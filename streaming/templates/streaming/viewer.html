<!DOCTYPE html>
<html>

<head>
    <title>👀 Viewer</title>
</head>

<body>
    <h2>👀 Viewer</h2>
    <input id="room" placeholder="Enter room ID" value="room1">
    <button id="connect">Connect</button>
    <br><br>

    <video id="remoteVideo" autoplay playsinline muted
        style="width: 640px; height: 480px; border: 1px solid black; background: #333;">
    </video>

    <script>
        const connectBtn = document.getElementById("connect");
        const remoteVideo = document.getElementById("remoteVideo");
        const roomInput = document.getElementById("room");

        connectBtn.onclick = async () => {
            const room_id = roomInput.value.trim();
            if (!room_id) return alert("Enter a room ID!");

            const pc = new RTCPeerConnection();

            pc.ontrack = (event) => {
                console.log("Got track!", event.track.kind);

                // Gán stream (giống code gốc của bạn)
                // Chúng ta kiểm tra để chỉ gán 1 lần
                if (remoteVideo.srcObject !== event.streams[0]) {
                    console.log("Assigning stream to video element");
                    remoteVideo.srcObject = event.streams[0];
                }

                // THAY ĐỔI 2: Cố gắng 'play()' thủ công và bắt lỗi
                const playPromise = remoteVideo.play();

                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Tự động phát thành công!
                        console.log("Video playback started successfully.");
                    }).catch(error => {
                        // Tự động phát THẤT BẠI
                        console.error("Video playback FAILED:", error);
                        alert("Trình duyệt đã chặn tự động phát. Hãy thử tương tác với trang.");
                    });
                }
            };

            pc.addTransceiver("video", { direction: "recvonly" });
            pc.addTransceiver("audio", { direction: "recvonly" });

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Giữ nguyên URL đã sửa
            const response = await fetch("/viewer_connect", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type, room_id })
            });

            if (!response.ok) {
                const text = await response.text();
                alert("Server error: " + text);
                return;
            }

            const answer = await response.json();
            await pc.setRemoteDescription(answer);
            console.log("👀 Connected to room:", room_id);
        };
    </script>
</body>

</html>