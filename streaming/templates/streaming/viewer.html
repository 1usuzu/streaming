<!DOCTYPE html>
<html>

<head>
    <title>ðŸ‘€ Viewer</title>
</head>

<body>
    <h2>ðŸ‘€ Viewer</h2>
    <input id="room" placeholder="Enter room ID" value="room1">
    <button id="connect">Connect</button>
    <br><br>

    <video id="remoteVideo" autoplay playsinline muted
        style="width: 640px; height: 480px; border: 1px solid black; background: #333;">
    </video>

    <script>
        const connectBtn = document.getElementById("connect");
        const remoteVideo = document.getElementById("remoteVideo");
        const roomInput = document.getElementById("room");

        connectBtn.onclick = async () => {
            const room_id = roomInput.value.trim();
            if (!room_id) return alert("Enter a room ID!");

            const pc = new RTCPeerConnection();

            pc.ontrack = (event) => {
                console.log("Got track!", event.track.kind);

                // GÃ¡n stream (giá»‘ng code gá»‘c cá»§a báº¡n)
                // ChÃºng ta kiá»ƒm tra Ä‘á»ƒ chá»‰ gÃ¡n 1 láº§n
                if (remoteVideo.srcObject !== event.streams[0]) {
                    console.log("Assigning stream to video element");
                    remoteVideo.srcObject = event.streams[0];
                }

                // THAY Äá»”I 2: Cá»‘ gáº¯ng 'play()' thá»§ cÃ´ng vÃ  báº¯t lá»—i
                const playPromise = remoteVideo.play();

                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Tá»± Ä‘á»™ng phÃ¡t thÃ nh cÃ´ng!
                        console.log("Video playback started successfully.");
                    }).catch(error => {
                        // Tá»± Ä‘á»™ng phÃ¡t THáº¤T Báº I
                        console.error("Video playback FAILED:", error);
                        alert("TrÃ¬nh duyá»‡t Ä‘Ã£ cháº·n tá»± Ä‘á»™ng phÃ¡t. HÃ£y thá»­ tÆ°Æ¡ng tÃ¡c vá»›i trang.");
                    });
                }
            };

            pc.addTransceiver("video", { direction: "recvonly" });
            pc.addTransceiver("audio", { direction: "recvonly" });

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Giá»¯ nguyÃªn URL Ä‘Ã£ sá»­a
            const response = await fetch("/viewer_connect", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type, room_id })
            });

            if (!response.ok) {
                const text = await response.text();
                alert("Server error: " + text);
                return;
            }

            const answer = await response.json();
            await pc.setRemoteDescription(answer);
            console.log("ðŸ‘€ Connected to room:", room_id);
        };
    </script>
</body>

</html>